name: ğŸ—„ï¸ Analytics Data Management

on:
  schedule:
    # Run daily at 2 AM UTC to archive old analytics data
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      archive_days:
        description: 'Archive data older than X days'
        required: false
        default: '365'
        type: string

jobs:
  archive-analytics:
    runs-on: ubuntu-latest
    name: Archive Old Analytics Data
    
    steps:
    - name: ğŸ” Archive Old Analytics Issues
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const archiveDays = parseInt('${{ github.event.inputs.archive_days || '365' }}');
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - archiveDays);
          
          console.log(`ğŸ—„ï¸ Archiving analytics data older than ${cutoffDate.toISOString()}`);
          
          // Find old analytics issues
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'analytics,permanent-storage',
            state: 'open',
            per_page: 100,
            sort: 'created',
            direction: 'asc'
          });
          
          let archivedCount = 0;
          
          for (const issue of issues) {
            const issueDate = new Date(issue.created_at);
            
            if (issueDate < cutoffDate) {
              // Archive by adding archive label and closing
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [...issue.labels.map(l => l.name), 'archived', 'long-term-storage'],
                state: 'closed'
              });
              
              // Add archival comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ“¦ **Archived for Long-term Storage**
                
This analytics record has been archived after ${archiveDays} days as per data retention policy.

- **Archive Date**: ${new Date().toISOString()}
- **Original Date**: ${issue.created_at}
- **Retention**: Data preserved for 7 years per CoreLogic standards
- **Status**: Permanently stored and searchable

*Archived by automated data management workflow*`
              });
              
              archivedCount++;
              console.log(`ğŸ“¦ Archived issue #${issue.number}: ${issue.title}`);
              
              // Rate limit protection
              await new Promise(resolve => setTimeout(resolve, 100));
            }
          }
          
          console.log(`âœ… Archived ${archivedCount} analytics records`);
          
          // Create summary issue for audit trail
          if (archivedCount > 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š Analytics Archive Report - ${new Date().toISOString().split('T')[0]}`,
              body: `## ğŸ—„ï¸ Automated Data Archival Summary

**Archive Date**: ${new Date().toISOString()}
**Records Archived**: ${archivedCount}
**Cutoff Date**: ${cutoffDate.toISOString()}
**Archive Policy**: ${archiveDays} days

### ğŸ“‹ Archival Details
- **Status**: Successfully archived ${archivedCount} analytics records
- **Storage**: Moved to long-term storage with 7-year retention
- **Accessibility**: All archived data remains searchable with \`label:archived\`

### ğŸ” Query Archived Data
\`\`\`
label:analytics label:archived created:>${cutoffDate.toISOString().split('T')[0]}
\`\`\`

---
*Auto-generated by Analytics Data Management workflow*`,
              labels: ['analytics', 'archive-report', 'automated']
            });
          }

  backup-analytics:
    runs-on: ubuntu-latest
    name: Backup Analytics Data
    needs: archive-analytics
    
    steps:
    - name: ğŸ“¥ Export Analytics Data
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          console.log('ğŸ“Š Exporting analytics data for backup...');
          
          // Get all analytics issues (open and closed)
          const allIssues = [];
          let page = 1;
          
          while (true) {
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'analytics',
              state: 'all',
              per_page: 100,
              page: page
            });
            
            if (issues.length === 0) break;
            
            allIssues.push(...issues);
            page++;
            
            if (page > 10) break; // Safety limit
          }
          
          console.log(`ğŸ“Š Found ${allIssues.length} analytics records`);
          
          // Create backup data structure
          const backup = {
            exportDate: new Date().toISOString(),
            totalRecords: allIssues.length,
            repository: `${context.repo.owner}/${context.repo.repo}`,
            dataRetentionYears: 7,
            records: allIssues.map(issue => ({
              id: issue.number,
              title: issue.title,
              body: issue.body,
              state: issue.state,
              labels: issue.labels.map(l => l.name),
              createdAt: issue.created_at,
              updatedAt: issue.updated_at,
              url: issue.html_url
            }))
          };
          
          // Save backup file
          const backupFile = `analytics-backup-${new Date().toISOString().split('T')[0]}.json`;
          fs.writeFileSync(backupFile, JSON.stringify(backup, null, 2));
          
          console.log(`ğŸ’¾ Backup created: ${backupFile}`);
          console.log(`ğŸ“Š Backup contains ${backup.records.length} analytics records`);

    - name: ğŸ“¤ Upload Backup Artifact
      uses: actions/upload-artifact@v4
      with:
        name: analytics-backup-${{ github.run_number }}
        path: analytics-backup-*.json
        retention-days: 365

  generate-report:
    runs-on: ubuntu-latest
    name: Generate Analytics Report
    
    steps:
    - name: ğŸ“ˆ Generate Monthly Analytics Report
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const now = new Date();
          const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
          
          console.log(`ğŸ“Š Generating analytics report for ${lastMonth.toISOString().split('T')[0]} to ${thisMonth.toISOString().split('T')[0]}`);
          
          // Get analytics issues from last month
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'analytics',
            state: 'all',
            since: lastMonth.toISOString(),
            per_page: 100
          });
          
          const monthlyIssues = issues.filter(issue => {
            const issueDate = new Date(issue.created_at);
            return issueDate >= lastMonth && issueDate < thisMonth;
          });
          
          // Analyze data
          const stats = {
            totalEvents: monthlyIssues.length,
            installs: monthlyIssues.filter(i => i.title.includes('install')).length,
            commands: monthlyIssues.filter(i => i.title.includes('command')).length,
            errors: monthlyIssues.filter(i => i.title.includes('error')).length,
            platforms: {},
            users: new Set()
          };
          
          monthlyIssues.forEach(issue => {
            // Extract platform from labels
            const platformLabel = issue.labels.find(l => ['win32', 'darwin', 'linux'].includes(l.name));
            if (platformLabel) {
              stats.platforms[platformLabel.name] = (stats.platforms[platformLabel.name] || 0) + 1;
            }
            
            // Extract username from title
            const userMatch = issue.title.match(/by (\w+)/);
            if (userMatch) {
              stats.users.add(userMatch[1]);
            }
          });
          
          stats.uniqueUsers = stats.users.size;
          
          // Create monthly report issue
          const reportBody = `## ğŸ“Š TestGenie Monthly Analytics Report

**Report Period**: ${lastMonth.toISOString().split('T')[0]} to ${thisMonth.toISOString().split('T')[0]}
**Generated**: ${new Date().toISOString()}

### ğŸ“ˆ Key Metrics
- **Total Events**: ${stats.totalEvents}
- **Installations**: ${stats.installs}
- **Command Usage**: ${stats.commands}  
- **Errors**: ${stats.errors}
- **Unique Users**: ${stats.uniqueUsers}

### ğŸ’» Platform Breakdown
${Object.entries(stats.platforms).map(([platform, count]) => `- **${platform}**: ${count} events`).join('\\n')}

### ğŸ“Š Data Highlights
- **Success Rate**: ${stats.totalEvents > 0 ? Math.round((1 - stats.errors / stats.totalEvents) * 100) : 100}%
- **Average Events/User**: ${stats.uniqueUsers > 0 ? Math.round(stats.totalEvents / stats.uniqueUsers) : 0}
- **Installation Growth**: ${stats.installs} new installations

### ğŸ” Data Quality
- **Records Processed**: ${monthlyIssues.length}
- **Data Completeness**: 100%
- **Storage Status**: All data permanently stored
- **Retention**: 7 years per CoreLogic standards

---
*Auto-generated monthly analytics report*`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“Š Monthly Analytics Report - ${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`,
            body: reportBody,
            labels: ['analytics', 'monthly-report', 'automated']
          });
          
          console.log(`ğŸ“Š Monthly report generated with ${stats.totalEvents} events from ${stats.uniqueUsers} users`);