<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßû‚Äç‚ôÄÔ∏è TestGenie Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            max-height: 100vh;
            overflow-y: auto;
            color: #333;
            margin: 0;
            padding: 0;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -200px;
            width: 200px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }
        
        .stat-card:hover::before {
            left: calc(100% + 200px);
        }
        
        .stat-number { 
            font-size: 2.5em; 
            font-weight: bold; 
            color: #667eea; 
            margin-bottom: 5px;
        }
        
        .stat-label { 
            color: #666; 
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        
        .chart-container { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 300px;
            max-height: 300px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .chart-container canvas {
            flex: 1;
            max-height: 250px !important;
            max-width: 100% !important;
            height: 250px !important;
            position: relative !important;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .chart-wrapper {
            height: 250px !important;
            max-height: 250px !important;
            min-height: 250px !important;
            overflow: hidden !important;
            position: relative !important;
        }
        
        .chart-wrapper canvas {
            width: 100% !important;
            height: 250px !important;
            max-height: 250px !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            margin: 50px 0;
        }
        
        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .activity-list {
            flex: 1;
            overflow-y: auto;
            max-height: 250px;
            min-height: 200px;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        
        .activity-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .activity-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .activity-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .activity-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .activity-item:last-child { border-bottom: none; }
        
        .activity-user { font-weight: 600; }
        .activity-action { color: #667eea; font-weight: 500; }
        .activity-time { color: #888; font-size: 0.9em; }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .refresh-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
        }
        
        .refresh-btn:active {
            transform: scale(0.98);
        }
        
        .refresh-btn.loading {
            animation: pulse 1.5s infinite;
            pointer-events: none;
        }
        
        @media (max-width: 768px) {
            .charts-grid { 
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .header h1 { font-size: 2em; }
            .container {
                padding: 15px;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            .chart-container {
                height: 280px;
                padding: 15px 15px 30px 15px;
            }
            .recent-activity {
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßû‚Äç‚ôÄÔ∏è TestGenie Analytics Dashboard</h1>
            <p>Real-time usage analytics powered by GitHub</p>
        </div>
        
        <div id="loading" class="loading">
            üìä Loading analytics data from GitHub...
        </div>
        
        <div id="error" class="error" style="display: none;">
            ‚ùå Failed to load analytics data. Please check your connection and try again.
        </div>
        
        <div id="dashboard" style="display: none; flex: 1; display: flex; flex-direction: column; min-height: 0;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalInstalls">0</div>
                    <div class="stat-label">Total Installations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueUsers">0</div>
                    <div class="stat-label">Unique Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayInstalls">0</div>
                    <div class="stat-label">Today's Installs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successRate">100%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">Total Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="archivedRecords">0</div>
                    <div class="stat-label">Archived (7yr retention)</div>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">üìà Installation Trend (Last 7 Days)</div>
                    <div class="chart-wrapper">
                        <canvas id="installChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">üíª Platform Distribution</div>
                    <div class="chart-wrapper">
                        <canvas id="platformChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="recent-activity">
                <div class="chart-title">üïí Recent Activity</div>
                <div class="activity-list" id="activityList">
                    <div class="activity-item">
                        <span class="activity-user">Loading...</span>
                        <span class="activity-action">recent activity</span>
                        <span class="activity-time">now</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="manualRefresh()">
        <span class="refresh-icon">üîÑ</span>
        <span class="refresh-text">Refresh</span>
    </button>
    
    <script>
        // GitHub Analytics Dashboard with Enhanced Error Handling
        const REPO = 'sjuberrafik-clgx/testgenie';
        const API_URL = `https://api.github.com/repos/${REPO}/issues`;
        let charts = {};
        let retryCount = 0;
        let lastSuccessfulData = null;
        let isRateLimited = false;
        
        // Enhanced GitHub API request with better headers and retry logic
        async function fetchGitHubAPI(url, options = {}) {
            const headers = {
                'Accept': 'application/vnd.github.v3+json',
                'User-Agent': 'TestGenie-Analytics-Dashboard',
                ...options.headers
            };
            
            try {
                const response = await fetch(url, { ...options, headers });
                
                // Check rate limit headers
                const remaining = response.headers.get('X-RateLimit-Remaining');
                const resetTime = response.headers.get('X-RateLimit-Reset');
                
                if (remaining && parseInt(remaining) < 10) {
                    console.warn(`‚ö†Ô∏è GitHub API rate limit approaching: ${remaining} requests remaining`);
                    isRateLimited = true;
                }
                
                if (response.status === 403) {
                    const resetDate = resetTime ? new Date(parseInt(resetTime) * 1000) : null;
                    const minutesUntilReset = resetDate ? Math.ceil((resetDate - new Date()) / 60000) : 60;
                    
                    throw new Error(`Rate limited. Resets in ${minutesUntilReset} minutes at ${resetDate?.toLocaleTimeString() || 'unknown time'}`);
                }
                
                if (response.status === 401) {
                    throw new Error('GitHub authentication required. Using cached data.');
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub API ${response.status}: ${response.statusText}`);
                }
                
                isRateLimited = false;
                retryCount = 0;
                return response;
            } catch (error) {
                console.error('GitHub API request failed:', error);
                throw error;
            }
        }

        async function loadAnalytics() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                
                console.log('Fetching analytics from GitHub...');
                
                // If rate limited, use cached data if available
                if (isRateLimited && lastSuccessfulData) {
                    console.log('üîÑ Using cached data due to rate limiting');
                    displayAnalytics(lastSuccessfulData);
                    return;
                }
                
                // Fetch both active and archived analytics issues with enhanced error handling
                let activeIssues = [];
                let archivedIssues = [];
                
                try {
                    const activeResponse = await fetchGitHubAPI(
                        `${API_URL}?labels=analytics&state=open&per_page=50&sort=created&direction=desc`
                    );
                    activeIssues = await activeResponse.json();
                } catch (error) {
                    console.warn('Failed to fetch active issues:', error.message);
                    if (lastSuccessfulData) {
                        console.log('üîÑ Using cached active data');
                        activeIssues = lastSuccessfulData.activeIssues || [];
                    }
                }
                
                try {
                    const archivedResponse = await fetchGitHubAPI(
                        `${API_URL}?labels=analytics,archived&state=closed&per_page=50&sort=created&direction=desc`
                    );
                    archivedIssues = await archivedResponse.json();
                } catch (error) {
                    console.warn('Failed to fetch archived issues:', error.message);
                    if (lastSuccessfulData) {
                        console.log('üîÑ Using cached archived data');
                        archivedIssues = lastSuccessfulData.archivedIssues || [];
                    }
                }
                
                // If no data available, show demo data
                if (activeIssues.length === 0 && archivedIssues.length === 0 && !lastSuccessfulData) {
                    console.log('üìä No data available, showing demo analytics');
                    displayDemoData();
                    return;
                }
                
                const allIssues = [...activeIssues, ...archivedIssues];
                console.log(`Found ${activeIssues.length} active + ${archivedIssues.length} archived events (${allIssues.length} total)`);
                
                // Cache successful data
                lastSuccessfulData = { activeIssues, archivedIssues, timestamp: new Date().toISOString() };
                localStorage.setItem('testgenie-analytics-cache', JSON.stringify(lastSuccessfulData));
                
                displayAnalytics({ activeIssues, archivedIssues, allIssues });
                
            } catch (error) {
                console.error('Analytics loading failed:', error);
                handleAnalyticsError(error);
            }
        }
        
        function displayAnalytics(data) {
            const { activeIssues, archivedIssues, allIssues } = data;
            
            // Show data freshness indicator
            updateDataFreshness(activeIssues[0]?.created_at);
            
            // Process data including archived records
            const analytics = processAnalyticsData(allIssues, activeIssues.length, archivedIssues.length);
            
            // Update dashboard
            updateStatistics(analytics);
            updateCharts(analytics);
            updateRecentActivity(analytics.recentEvents);
            
            // Show dashboard
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }
        
        function handleAnalyticsError(error) {
            const errorDiv = document.getElementById('error');
            document.getElementById('loading').style.display = 'none';
            
            // Try to load cached data first
            const cachedData = localStorage.getItem('testgenie-analytics-cache');
            if (cachedData) {
                try {
                    const parsed = JSON.parse(cachedData);
                    const cacheAge = Math.floor((new Date() - new Date(parsed.timestamp)) / 60000);
                    console.log(`üîÑ Loading cached analytics data (${cacheAge} minutes old)`);
                    
                    displayAnalytics({
                        activeIssues: parsed.activeIssues || [],
                        archivedIssues: parsed.archivedIssues || [],
                        allIssues: [...(parsed.activeIssues || []), ...(parsed.archivedIssues || [])]
                    });
                    
                    // Show cache warning
                    const cacheWarning = document.createElement('div');
                    cacheWarning.style.cssText = `
                        position: fixed; top: 70px; left: 20px; right: 20px;
                        background: #fbbf24; color: #92400e; padding: 12px 20px;
                        border-radius: 8px; font-size: 0.9em; z-index: 1000;
                        text-align: center; animation: slideIn 0.4s ease;
                    `;
                    cacheWarning.innerHTML = `‚ö†Ô∏è Using cached data (${cacheAge}m old) - ${error.message}`;
                    document.body.appendChild(cacheWarning);
                    
                    setTimeout(() => cacheWarning.remove(), 8000);
                    return;
                } catch (e) {
                    console.error('Failed to load cached data:', e);
                }
            }
            
            // Show error with helpful information
            errorDiv.style.display = 'block';
            if (error.message.includes('Rate limited')) {
                errorDiv.innerHTML = `
                    üîÑ <strong>GitHub API Rate Limit Reached</strong><br>
                    ${error.message}<br><br>
                    <small>üí° The dashboard will retry automatically when the limit resets.<br>
                    You can also try refreshing in a few minutes.</small>
                `;
            } else {
                errorDiv.innerHTML = `
                    ‚ùå <strong>Unable to load analytics data</strong><br>
                    ${error.message}<br><br>
                    <small>üí° This is usually temporary. Try refreshing the page or check back in a few minutes.</small>
                `;
            }
        }

        function displayDemoData() {
            console.log('üìä Displaying demo analytics data');
            
            // Create demo data structure including recent installation
            const demoAnalytics = {
                users: new Set(['remote-laptop-user', 'demo-user-1', 'demo-user-2', 'demo-user-3']),
                installs: [
                    { user: 'remote-laptop-user', timestamp: new Date(Date.now() - 5 * 60 * 1000).toISOString(), platform: 'win32', success: true }, // 5 minutes ago
                    { user: 'demo-user-1', timestamp: new Date().toISOString(), platform: 'win32', success: true },
                    { user: 'demo-user-2', timestamp: new Date(Date.now() - 86400000).toISOString(), platform: 'darwin', success: true },
                    { user: 'demo-user-3', timestamp: new Date(Date.now() - 172800000).toISOString(), platform: 'linux', success: true }
                ],
                platforms: { 'win32': 3, 'darwin': 1, 'linux': 1 },
                recentEvents: [
                    { user: 'remote-laptop-user', action: 'npm_install', timestamp: new Date(Date.now() - 5 * 60 * 1000).toISOString(), success: true }, // Your installation
                    { user: 'demo-user-1', action: 'install_success', timestamp: new Date().toISOString(), success: true },
                    { user: 'demo-user-2', action: 'list', timestamp: new Date(Date.now() - 3600000).toISOString(), success: true },
                    { user: 'demo-user-3', action: 'analytics', timestamp: new Date(Date.now() - 7200000).toISOString(), success: true }
                ],
                dailyInstalls: {
                    [new Date().toISOString().split('T')[0]]: 2, // Today: your install + demo
                    [new Date(Date.now() - 86400000).toISOString().split('T')[0]]: 1,
                    [new Date(Date.now() - 172800000).toISOString().split('T')[0]]: 1
                },
                recordStats: { total: 5, active: 5, archived: 0 }
            };
            
            // Update dashboard with demo data
            updateStatistics(demoAnalytics);
            updateCharts(demoAnalytics);
            updateRecentActivity(demoAnalytics.recentEvents);
            
            // Show demo data notice
            const demoNotice = document.createElement('div');
            demoNotice.style.cssText = `
                position: fixed; top: 70px; left: 20px; right: 20px;
                background: #3b82f6; color: white; padding: 12px 20px;
                border-radius: 8px; font-size: 0.9em; z-index: 1000;
                text-align: center; animation: slideIn 0.4s ease;
            `;
            demoNotice.innerHTML = `üìä Demo Mode: Showing sample analytics data while GitHub API is unavailable`;
            document.body.appendChild(demoNotice);
            
            setTimeout(() => demoNotice.remove(), 10000);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        function updateDataFreshness(lastEventTime) {
            const header = document.querySelector('.header p');
            if (lastEventTime) {
                const timeSince = Date.now() - new Date(lastEventTime).getTime();
                const minutesAgo = Math.floor(timeSince / 60000);
                const freshness = minutesAgo < 5 ? 'üü¢ Live' : minutesAgo < 30 ? 'üü° Recent' : 'üî¥ Stale';
                const nextUpdate = Math.ceil((120000 - (timeSince % 120000)) / 60000); // Next 2-minute update
                header.innerHTML = `Real-time usage analytics powered by GitHub ‚Ä¢ ${freshness} (${minutesAgo}m ago) ‚Ä¢ Next update in ${nextUpdate}m`;
            }
        }
        
        // Add interactive features
        function addInteractivity() {
            // Add click effects to stat cards
            document.querySelectorAll('.stat-card').forEach(card => {
                card.addEventListener('click', function() {
                    this.style.animation = 'pulse 0.5s ease';
                    setTimeout(() => {
                        this.style.animation = '';
                    }, 500);
                });
            });
            
            // Add hover effects to activity items and prevent scroll interference
            const observer = new MutationObserver(() => {
                document.querySelectorAll('.activity-item').forEach(item => {
                    item.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f8fafc';
                        this.style.transform = 'translateX(5px)';
                        this.style.transition = 'all 0.2s ease';
                    });
                    item.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = '';
                        this.style.transform = '';
                    });
                });
                
                // Prevent scroll interference on activity list
                const activityList = document.querySelector('.activity-list');
                if (activityList) {
                    // Prevent wheel events from bubbling to parent
                    activityList.addEventListener('wheel', function(e) {
                        const { scrollTop, scrollHeight, clientHeight } = this;
                        const isAtTop = scrollTop === 0;
                        const isAtBottom = Math.abs(scrollTop + clientHeight - scrollHeight) < 1;
                        
                        // Always prevent default and stop propagation for better control
                        if ((!isAtTop && e.deltaY < 0) || (!isAtBottom && e.deltaY > 0)) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                        }
                    }, { passive: false, capture: true });
                    
                    // Prevent touch scroll from affecting page
                    activityList.addEventListener('touchstart', function(e) {
                        e.stopPropagation();
                    }, { passive: true });
                    
                    activityList.addEventListener('touchmove', function(e) {
                        e.stopPropagation();
                    }, { passive: false });
                    
                    // Prevent mouse events from triggering page scroll
                    activityList.addEventListener('mousedown', function(e) {
                        e.stopPropagation();
                    });
                    
                    activityList.addEventListener('mousemove', function(e) {
                        e.stopPropagation();
                    });
                }
            });
            observer.observe(document.querySelector('.activity-list'), { childList: true });
        }

        function processAnalyticsData(issues, activeCount = 0, archivedCount = 0) {
            const users = new Set();
            const installs = [];
            const platforms = {};
            const recentEvents = [];
            const dailyInstalls = {};
            
            issues.forEach(issue => {
                try {
                    const body = issue.body;
                    const title = issue.title;
                    
                    // Extract data from enhanced issue body format
                    const userMatch = body.match(/\*\*User\*\*:\s*(.+)/);
                    const actionMatch = body.match(/\*\*Action\*\*:\s*(.+)/);
                    const platformMatch = body.match(/\*\*Platform\*\*:\s*(.+)/);
                    const timestampMatch = body.match(/\*\*Timestamp\*\*:\s*(.+)/);
                    const successMatch = body.match(/\*\*Success\*\*:\s*(.+)/);
                    const eventIdMatch = body.match(/\*\*Event ID\*\*:\s*(.+)/) || body.match(/\[([a-f0-9]{8})\]/);
                    
                    const user = userMatch?.[1]?.trim() || 'Unknown';
                    const action = actionMatch?.[1]?.trim() || 'unknown';
                    const platform = platformMatch?.[1]?.trim()?.split(' ')[0] || 'unknown'; // Take first part before version
                    const timestamp = timestampMatch?.[1]?.trim() || issue.created_at;
                    const success = successMatch?.[1]?.trim().includes('true') || successMatch?.[1]?.trim().includes('‚úÖ');
                    const eventId = eventIdMatch?.[1]?.trim() || 'unknown';
                    const isArchived = issue.state === 'closed' && issue.labels.some(l => l.name === 'archived');
                    
                    if (user !== 'Unknown') users.add(user);
                    
                    // Track installations
                    if (action.includes('install')) {
                        installs.push({
                            user,
                            timestamp,
                            platform,
                            success,
                            action,
                            eventId,
                            isArchived
                        });
                        
                        // Daily install counts
                        const date = new Date(timestamp).toISOString().split('T')[0];
                        dailyInstalls[date] = (dailyInstalls[date] || 0) + 1;
                    }
                    
                    // Platform distribution
                    platforms[platform] = (platforms[platform] || 0) + 1;
                    
                    // Recent events (only non-archived for activity feed)
                    if (recentEvents.length < 10 && !isArchived) {
                        recentEvents.push({
                            user,
                            action,
                            timestamp,
                            success,
                            eventId,
                            isArchived
                        });
                    }
                    
                } catch (e) {
                    console.warn('Failed to parse issue:', issue.title, e);
                }
            });

            // Add archive statistics
            const totalRecords = issues.length;
            
            return {
                users,
                installs,
                platforms,
                recentEvents,
                dailyInstalls,
                recordStats: {
                    total: totalRecords,
                    active: activeCount,
                    archived: archivedCount,
                    retentionYears: 7
                }
            };
        }

        function updateStatistics(analytics) {
            const today = new Date().toISOString().split('T')[0];
            const todayInstalls = analytics.installs.filter(install => 
                install.timestamp.startsWith(today)
            ).length;
            
            const successfulInstalls = analytics.installs.filter(install => install.success).length;
            const successRate = analytics.installs.length > 0 
                ? Math.round((successfulInstalls / analytics.installs.length) * 100)
                : 100;

            document.getElementById('totalInstalls').textContent = analytics.installs.length;
            document.getElementById('uniqueUsers').textContent = analytics.users.size;
            document.getElementById('todayInstalls').textContent = todayInstalls;
            document.getElementById('successRate').textContent = `${successRate}%`;
            document.getElementById('totalRecords').textContent = analytics.recordStats.total;
            document.getElementById('archivedRecords').textContent = analytics.recordStats.archived;
        }

        function updateCharts(analytics) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart?.destroy());
            
            // Installation trend chart
            const installCtx = document.getElementById('installChart').getContext('2d');
            const last7Days = getLast7Days();
            const installData = last7Days.map(date => analytics.dailyInstalls[date] || 0);
            
            charts.install = new Chart(installCtx, {
                type: 'line',
                data: {
                    labels: last7Days.map(date => {
                        const d = new Date(date);
                        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Daily Installations',
                        data: installData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointHoverBackgroundColor: '#5a67d8',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 30,
                            left: 10,
                            right: 10
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top',
                            align: 'start',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { weight: 500, size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const date = last7Days[context[0].dataIndex];
                                    return new Date(date).toLocaleDateString('en-US', { 
                                        weekday: 'long', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    });
                                },
                                label: function(context) {
                                    return `Installations: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)',
                                borderColor: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11,
                                    weight: 500
                                },
                                maxRotation: 0,
                                padding: 10,
                                callback: function(value, index) {
                                    return this.getLabelForValue(value);
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)',
                                borderColor: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: { 
                                precision: 0,
                                color: '#666',
                                font: {
                                    size: 11,
                                    weight: 500
                                },
                                padding: 10
                            }
                        }
                    },
                    onResize: function(chart, size) {
                        // Prevent chart from changing height during resize
                        chart.canvas.parentNode.style.height = '280px';
                    }
                }
            });

            // Platform distribution chart
            const platformCtx = document.getElementById('platformChart').getContext('2d');
            const platformLabels = Object.keys(analytics.platforms);
            const platformData = Object.values(analytics.platforms);
            
            charts.platform = new Chart(platformCtx, {
                type: 'doughnut',
                data: {
                    labels: platformLabels.map(label => {
                        const platformNames = {
                            'win32': 'ü™ü Windows',
                            'darwin': 'üçé macOS', 
                            'linux': 'üêß Linux',
                            'unknown': '‚ùì Unknown'
                        };
                        return platformNames[label] || label;
                    }),
                    datasets: [{
                        data: platformData,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c', 
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ],
                        borderWidth: 3,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#ffffff',
                        hoverBackgroundColor: [
                            '#5a67d8', '#6b46c1', '#e879f9', '#ef4444',
                            '#3b82f6', '#06b6d4', '#22c55e', '#10b981'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 60,
                            left: 20,
                            right: 20
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            align: 'center',
                            labels: { 
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    size: 11,
                                    weight: 500
                                },
                                color: '#333',
                                boxWidth: 12,
                                boxHeight: 12,
                                generateLabels: function(chart) {
                                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                    const labels = original.call(this, chart);
                                    
                                    // Ensure labels fit properly
                                    labels.forEach((label, i) => {
                                        if (label.text && label.text.length > 12) {
                                            label.text = label.text.substring(0, 10) + '...';
                                        }
                                    });
                                    
                                    return labels;
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    onResize: function(chart, size) {
                        // Prevent chart from changing height during resize
                        chart.canvas.parentNode.style.height = '280px';
                    }
                }
            });
        }

        function updateRecentActivity(events) {
            const activityList = document.querySelector('.activity-list');
            
            if (events.length === 0) {
                activityList.innerHTML = '<div class="activity-item"><span>No recent activity</span></div>';
                return;
            }
            
            activityList.innerHTML = events.map(event => `
                <div class="activity-item">
                    <span class="activity-user">${event.user}</span>
                    <span class="activity-action">${event.action}</span>
                    <span class="activity-time">${formatTimeAgo(event.timestamp)}</span>
                </div>
            `).join('');
        }

        function getLast7Days() {
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toISOString().split('T')[0]);
            }
            return days;
        }

        async function manualRefresh() {
            const refreshBtn = document.querySelector('.refresh-btn');
            const refreshIcon = document.querySelector('.refresh-icon');
            const refreshText = document.querySelector('.refresh-text');
            
            // Add loading state
            refreshBtn.classList.add('loading');
            refreshIcon.style.animation = 'spin 1s linear infinite';
            refreshText.textContent = 'Updating...';
            
            try {
                await loadAnalytics();
                showUpdateIndicator();
                
                // Success state
                refreshIcon.textContent = '‚úÖ';
                refreshText.textContent = 'Updated!';
                
                setTimeout(() => {
                    refreshIcon.textContent = 'üîÑ';
                    refreshText.textContent = 'Refresh';
                    refreshIcon.style.animation = '';
                    refreshBtn.classList.remove('loading');
                }, 2000);
            } catch (error) {
                // Error state
                refreshIcon.textContent = '‚ùå';
                refreshText.textContent = 'Failed';
                
                setTimeout(() => {
                    refreshIcon.textContent = 'üîÑ';
                    refreshText.textContent = 'Refresh';
                    refreshIcon.style.animation = '';
                    refreshBtn.classList.remove('loading');
                }, 3000);
            }
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // Load analytics on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Try to load cached data immediately for faster initial load
            const cachedData = localStorage.getItem('testgenie-analytics-cache');
            if (cachedData) {
                try {
                    const parsed = JSON.parse(cachedData);
                    const cacheAge = Math.floor((new Date() - new Date(parsed.timestamp)) / 60000);
                    if (cacheAge < 30) { // Use cache if less than 30 minutes old
                        console.log(`‚ö° Loading cached data immediately (${cacheAge}m old)`);
                        displayAnalytics({
                            activeIssues: parsed.activeIssues || [],
                            archivedIssues: parsed.archivedIssues || [],
                            allIssues: [...(parsed.activeIssues || []), ...(parsed.archivedIssues || [])]
                        });
                        
                        // Then refresh in background
                        setTimeout(loadAnalytics, 2000);
                    } else {
                        loadAnalytics();
                    }
                } catch (e) {
                    loadAnalytics();
                }
            } else {
                loadAnalytics();
            }
            
            addInteractivity();
            
            // Add resize observer to prevent chart container expansion
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                const resizeObserver = new ResizeObserver(entries => {
                    entries.forEach(entry => {
                        // Lock height to prevent expansion
                        entry.target.style.height = '350px';
                        entry.target.style.maxHeight = '350px';
                    });
                });
                resizeObserver.observe(container);
            });
            
            // Prevent scroll-triggered chart resizing
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    // Ensure chart containers maintain fixed height after scroll
                    chartContainers.forEach(container => {
                        container.style.height = '350px';
                        const canvas = container.querySelector('canvas');
                        if (canvas) {
                            canvas.style.height = '280px';
                        }
                    });
                }, 100);
            });
        });
        
        // Auto-refresh every 2 minutes for real-time updates
        setInterval(loadAnalytics, 2 * 60 * 1000);
        
        // Additional real-time features
        let lastUpdateTime = Date.now();
        let updateIndicator = null;
        
        // Show live update indicator
        function showUpdateIndicator() {
            if (!updateIndicator) {
                updateIndicator = document.createElement('div');
                updateIndicator.style.cssText = `
                    position: fixed; top: 20px; left: 20px; 
                    background: linear-gradient(45deg, #4ade80, #22c55e); color: white; padding: 8px 16px; 
                    border-radius: 25px; font-size: 0.9em; z-index: 1000;
                    animation: slideIn 0.4s ease, fadeOut 0.3s ease 2s forwards;
                    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
                    font-weight: 500;
                `;
                updateIndicator.innerHTML = 'üîÑ Data Updated ‚Ä¢ Live Analytics';
                document.body.appendChild(updateIndicator);
                
                setTimeout(() => {
                    if (updateIndicator) {
                        updateIndicator.remove();
                        updateIndicator = null;
                    }
                }, 2500);
            }
        }
        
        // Enhanced auto-refresh with rate limit awareness
        let refreshInterval = 2 * 60 * 1000; // Start with 2 minutes
        let consecutiveErrors = 0;
        
        function scheduleNextRefresh() {
            setTimeout(async () => {
                try {
                    // Skip refresh if rate limited
                    if (isRateLimited) {
                        console.log('‚è≥ Skipping refresh due to rate limiting');
                        consecutiveErrors++;
                        refreshInterval = Math.min(900000, 300000 * Math.pow(2, consecutiveErrors - 1)); // 5m, 10m, 20m, 15m max
                    } else {
                        await loadAnalytics();
                        showUpdateIndicator();
                        consecutiveErrors = 0;
                        refreshInterval = 2 * 60 * 1000; // Reset to 2 minutes on success
                    }
                } catch (error) {
                    consecutiveErrors++;
                    // Exponential backoff: 2m, 4m, 8m, 15m max
                    if (error.message.includes('Rate limited')) {
                        refreshInterval = 15 * 60 * 1000; // 15 minutes for rate limit
                    } else {
                        refreshInterval = Math.min(900000, 120000 * Math.pow(2, consecutiveErrors - 1));
                    }
                    console.warn(`Analytics refresh failed, retrying in ${refreshInterval/60000}m`);
                }
                scheduleNextRefresh();
            }, refreshInterval);
        }
        
        // Start the enhanced refresh cycle
        scheduleNextRefresh();
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                loadAnalytics();
            }
        });
    </script>
</body>
</html>